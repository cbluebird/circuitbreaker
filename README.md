# circuitbreaker
精弘熔断器

目前大部分开源的熔断器的实现主要是针对api的可连通判断,负载均衡的功能依赖其他的组件实现. 对于微精弘来说熔断器则面临更为复杂的挑战,我们需要面对内外网多api不稳定的场景,并且api的断路的持续时间可能会高达几个小时乃至几天都是有可能的.另外吗, 每一条api有提供两种方式来鉴权获取登陆凭证,并且经过验证,这两个鉴权的方式也不是稳定的.因此, 需要我们对这几条api的去检查状态, 并动态的对负载均衡中的api列表进行更新, 即在api断路时从列表摘除, 在服务恢复时候重新加入到负载均衡的列表.

最大的问题在于如何检测熔断的api已经恢复了呢,在大多数开源的方式中是将api的状态设置为半打开来探活api,但是在我们对负载负载均衡的情况下,应该在什么时候让流量流向这些半打开的api也成为了一个难题,因为我们需要选择一个负载均衡后的指定的api提供服务,我们应该在什么时候选择这些熔断的api呢,这似乎是个难题. 同时在可连通的api很少的时候,对于api的探活流量的损失也是需要考虑的,毕竟我们一个请求有时候响应需要几秒,那么在这几秒里都是半打开的状态 .

还有一个问题就是,路由的选择需要根据用户的密码绑定情况来进行选择,不能让用户选择一个没有绑定过密码的活跃api.为了解决这个问题我们不得不选择了两次的负载均衡来解决这个问题.

那么,如果负载均衡和健康状态检测难以平衡,那么我们能不能做拆分,将负载均衡器和探活指针的给拆分为两个组件,负载均衡用于负载健康的api,健康探针会定时的访问所有不健康的api 服务,并按照之前定义好的健康策略来轮训api,如果api恢复则会重新添加到负载均衡的服务中

和大部分开源的熔断器的区别

这是微精弘熔断器的开源实现,用于对多条api线路的监控检测与切换,需要实现以下的功能:

- 注册api到熔断器中(api的URL)
- 注册请求方法到复杂均衡器中,请求的URL地址通过注册的健康的api的URL负载均衡后得到
- 调用指定的方法,发送请求并判断响应的状态,并记录api的URL的健康情况到counter中
- counter的error数量达到一定的比例后就熔断URL,并设置失败的时间,并从负载均衡列表中摘除并添加到健康监测的探针中.
- 通过定时任务轮训熔断的api,如果服务恢复则重新将服务加入到负载均衡器中